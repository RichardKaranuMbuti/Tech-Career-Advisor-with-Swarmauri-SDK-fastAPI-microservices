<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get your career Guide</title>

    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 20px;
        }
        .chat-container {
            border: 1px solid #ced4da;
            border-radius: 10px;
            padding: 10px;
            background-color: white;
            height: 400px;
            overflow-y: auto;
        }
        .chat-message {
            display: flex;
            margin-bottom: 10px;
        }
        .chat-bubble {
            padding: 10px;
            border-radius: 15px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .user-message {
            justify-content: flex-end;
        }
        .user-message .chat-bubble {
            background-color: #e2f0ff;
            margin-left: auto;
        }
        .bot-message {
            justify-content: flex-start;
        }
        .bot-message .chat-bubble {
            background-color: #f1f1f1;
        }
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
        }
        .disabled-input {
            pointer-events: none;
            opacity: 0.5;
        }
        .side-panel {
            border: 1px solid #ced4da;
            border-radius: 10px;
            padding: 10px;
            background-color: #f1f1f1;
            height: 100%;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Header and description -->
    <header class="mb-4 text-center">
        <h1>Redefine your Career</h1>
        <p>Ask questions, take a survey, and interact with our AI to get a cool tech career</p>
    </header>

    <!-- Model select dropdown -->
    <div class="mb-3">
        <label for="modelSelect" class="form-label">Select Model:</label>
        <select id="modelSelect" class="form-select">
            <option value="" disabled selected>Select a model</option>
        </select>
    </div>

    <div class="row">
        <!-- Side panel with survey button and instructions -->
        <div class="col-md-6 mb-3">
            <div class="side-panel">
                <h4>Take the Survey</h4>
                <p>Click the button below to take a quick survey. Once submitted, the bot will provide insights based on your answers.</p>
                <button id="takeSurveyBtn" class="btn btn-primary w-100">Take the Survey</button>
            </div>
        </div>

        <!-- Side panel for general conversations -->
        <div class="col-md-6 mb-3">
            <div class="side-panel">
                <h4>Or Have General Conversations</h4>
                <p>Enter a system context and your message to start a general conversation.</p>
                <input type="text" id="systemContext" class="form-control mb-2" placeholder="How do you want the bot to respond?">
                <input type="text" id="generalUserInput" class="form-control mb-2" placeholder="Type your message...">
                <button id="generalSubmitBtn" class="btn btn-primary w-100" onclick="submitGeneralConversation()">Submit</button>
            </div>
        </div>
    </div>

    <!-- Chat interface -->
    <div class="chat-container mb-3" id="chatContainer"></div>

    <!-- Spinner while waiting for response -->
    <div id="spinner" class="spinner-container" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Modal for survey -->
<div class="modal fade" id="surveyModal" tabindex="-1" aria-labelledby="surveyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="surveyModalLabel">Survey</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="questionsList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitSurvey()">Submit Survey</button>
            </div>
        </div>
    </div>
</div>

<!-- JS to handle the logic -->
<script>
    let answers = [];  // To store user answers
    let surveyModal;  // Variable to store the modal instance

    // Fetch the list of models and populate the dropdown
    async function fetchModels() {
        try {
            const response = await fetch('/models');
            const data = await response.json();
            const modelSelect = document.getElementById('modelSelect');
            
            // Populate the dropdown with models
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching models:', error);
        }
    }

    // Fetch the questions and display them in the modal
    async function fetchQuestions() {
        try {
            const response = await fetch('/questions');
            const data = await response.json();
            const questionsList = document.getElementById('questionsList');
            questionsList.innerHTML = ''; // Clear previous questions

            // Display each question with a corresponding input
            data.questions.forEach((question, index) => {
                const questionElement = document.createElement('div');
                questionElement.innerHTML = `
                    <label for="answer${index}" class="form-label">${question}</label>
                    <input type="text" id="answer${index}" class="form-control mb-3" oninput="storeAnswer(${index})">
                `;
                questionsList.appendChild(questionElement);
            });
        } catch (error) {
            console.error('Error fetching questions:', error);
        }
    }

    // Store answers as the user inputs them
    function storeAnswer(index) {
        const answerInput = document.getElementById(`answer${index}`);
        answers[index] = answerInput.value;
    }

    // Format markdown-like text (e.g., bold for **text**)
    function formatMarkdown(text) {
        return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    }

    // Add a message to the chat container
    function addMessageToChat(message, isUser = false) {
        const chatContainer = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isUser ? 'user-message' : 'bot-message'}`;
        messageDiv.innerHTML = `<div class="chat-bubble"><p>${message}</p></div>`;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Submit the survey answers
    async function submitSurvey() {
        const modelName = document.getElementById('modelSelect').value;
        
        if (!modelName) {
            alert('Please select a model.');
            return;
        }

        const inputText = answers.join('\n');

        toggleLoadingState(true);

        addMessageToChat('User submitted survey. Waiting for response...', true);

        try {
            const response = await fetch('/converse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    input_text: inputText,
                    system_context: "",
                    model_name: modelName
                }),
            });

            const data = await response.json();
            const formattedResponse = formatMarkdown(data.response);

            addMessageToChat(formattedResponse, false);
        } catch (error) {
            console.error('Error during survey submission:', error);
        } finally {
            toggleLoadingState(false);
            surveyModal.hide(); // Hide the modal after submission
        }
    }

    // Submit general conversation
    async function submitGeneralConversation() {
        const modelName = document.getElementById('modelSelect').value;
        const systemContext = document.getElementById('systemContext').value;
        const userInput = document.getElementById('generalUserInput').value;

        if (!modelName) {
            alert('Please select a model.');
            return;
        }

        if (!userInput) {
            alert('Please type a message.');
            return;
        }

        toggleLoadingState(true);

        addMessageToChat(userInput, true);

        try {
            const response = await fetch('/general/converse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    input_text: userInput,
                    system_context: systemContext,
                    model_name: modelName
                }),
            });

            const data = await response.json();
            const formattedResponse = formatMarkdown(data.response);

            addMessageToChat(formattedResponse, false);
        } catch (error) {
            console.error('Error during general conversation submission:', error);
        } finally {
            toggleLoadingState(false);
            document.getElementById('generalUserInput').value = ''; // Clear input after submission
        }
    }

    // Show or hide the spinner
    function toggleLoadingState(isLoading) {
        const spinner = document.getElementById('spinner');
        const generalUserInput = document.getElementById('generalUserInput');
        const generalSubmitBtn = document.getElementById('generalSubmitBtn');

        if (isLoading) {
            spinner.style.display = 'block';
            generalUserInput.disabled = true;
            generalSubmitBtn.disabled = true;
        } else {
            spinner.style.display = 'none';
            generalUserInput.disabled = false;
            generalSubmitBtn.disabled = false;
        }
    }

    // Initialize the modal and set up event listeners
    function initializeModal() {
        const modalElement = document.getElementById('surveyModal');
        surveyModal = new bootstrap.Modal(modalElement);

        // Set up event listener for modal hidden event
        modalElement.addEventListener('hidden.bs.modal', function () {
            // Clear the answers when the modal is closed
            answers = [];
            document.getElementById('questionsList').innerHTML = '';
        });

        // Open the survey modal when the button is clicked
        document.getElementById('takeSurveyBtn').addEventListener('click', function () {
            surveyModal.show();
            fetchQuestions();  // Fetch the questions when the modal is opened
        });
    }

    // Function to initialize everything when the page loads
    function initializePage() {
        fetchModels();
        initializeModal();
    }

    // Call initializePage when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', initializePage);

    // Remove any existing event listeners that might have been set up incorrectly
    window.onload = null;
</script>

<!-- Bootstrap JS CDN (for modals) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>